function populate_edit_fields() { var e = Date.create($("#entry_begin_time").val()); var t = Date.create($("#entry_end_time").val()); var n = (t.minutesSince(e) / 60).toFixed(2); var r = e.format(date_format); var i = t.format(date_format); $(".begin_time").val(e.format(date_format)); $(".end_time").val(t.format(date_format)); $("#timespan").val(e.format("{M}/{dd}/{yy} {h}:{mm} {tt}") + " - " + t.format("{M}/{dd}/{yy} {h}:{mm} {tt}")); $("#total_hours").val(n) } var date_format = "{Dow} {Mon} {dd} {year} {h}:{mm} {tt}"; $(window).load(function () { $("#timespan").keyup(function () { var e = 2; var t = 3; var n = 4; var r = 5; var i = 0; var s = 1; var o = 2; var u = $(this).val(); var a = /(\d{1,2}(:\d{2})?)\s*([AaPp]\.?[Mm]?\.?)?/; var f = /(([^:-]*?)\s+)?/; var l = new RegExp("^" + f.source + a.source + "$"); var c = /^\s*([^-]+?)\s*(-|$)/; var h = /-\s*([^-]+?)\s*$/; var p = c.test(u) ? c.exec(u)[1] : ""; var d = h.test(u) ? h.exec(u)[1] : ""; var v = Date.create(p); var m = Date.create(d); var g = l.test(p); var y = l.test(d); if (g) { var b = l.exec(p); var w = [b[e], b[t], b[r]]; if (!w[i]) w[i] = "today"; if (!b[n]) w[s] += ":00"; if (w[o]) w[o] = /^[Pp]/.test(w[o]) ? "pm" : "am"; v = Date.create(w.join(" ")) } if (y) { var E = l.exec(d); var S = [E[e], E[t], E[r]]; if (!S[i]) { if (g) S[i] = w[i]; else S[i] = "today" } if (!E[n]) S[s] += ":00"; if (S[o]) S[o] = /^[Pp]/.test(S[o]) ? "pm" : "am"; m = Date.create(S.join(" ")) } if (g && y) { if (S[o] && !w[o]) w[o] = S[o]; else if (w[o] && !S[o]) S[o] = w[o]; w[o] = /^[Pp]/.test(w[o]) ? "pm" : "am"; S[o] = /^[Pp]/.test(S[o]) ? "pm" : "am"; v = Date.create(w.join(" ")); m = Date.create(S.join(" ")); while (m.minutesSince(v) <= 0) { if (!E[r]) m.addHours(12); else if (!b[r]) v.addHours(-12); else m.addHours(24) } } else { while (m.minutesSince(v) <= 0) { if (y) { if (E[r]) m.addHours(24); else m.addHours(12) } else if (g) { if (b[r]) v.addHours(-24); else v.addHours(-12) } else m.addHours(24) } if (m.hoursSince(v) >= 12 && m.hoursSince(v) < 24) { if (y && !E[r]) m.addHours(-12); else if (g && !b[r]) v.addHours(12) } } if (v.isValid() && m.isValid()) { while (v.getMinutes() % 5 != 0) { v.addMinutes(-1); m.addMinutes(-1) } while (m.getMinutes() % 5 != 0) m.addMinutes(1); v.reset("seconds"); m.reset("seconds") } var x = (m.minutesSince(v) / 60).toFixed(2); if (x == "NaN") x = "Waiting..."; $(".begin_time").val(v.isValid() ? v.format(date_format) : "Waiting..."); $(".end_time").val(m.isValid() ? m.format(date_format) : "Waiting..."); $("#total_hours").val(x) }) })